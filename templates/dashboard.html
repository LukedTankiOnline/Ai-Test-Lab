<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AI Test Lab - Dashboard</title>
    <style>
      body{font-family:Arial,Helvetica,sans-serif;margin:20px}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #ddd;padding:6px}
      th{background:#f3f3f3}
      .meta{font-size:0.9em;color:#666}
    </style>
  </head>
  <body>
    <h1>AI Test Lab - Logs</h1>
    <p>Recent prompts and responses. Rows are color-coded by risk score.</p>
    <p><button id="refresh">Refresh</button> <button id="export">Export Report</button></p>
    <table id="logs-table">
      <thead>
        <tr><th>ID</th><th>Session</th><th>Model</th><th>Prompt</th><th>Response</th><th>Latency (ms)</th><th>Risk</th></tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    <h2>Traffic Correlation</h2>
    <p>Traffic correlation plot (if generated by the analyzer):</p>
    <img id="traffic-plot" src="/artifacts/traffic_correlation.png" style="max-width:100%;display:block;margin:10px 0;" onerror="this.style.display='none'">

    <script>
      function colorForScore(s){
        if(s >= 70) return '#ffcccc';
        if(s >= 40) return '#fff2cc';
        if(s >= 10) return '#e6f7ff';
        return '#ffffff';
      }
      async function load(){
        const res = await fetch('/api/logs?limit=200');
        const data = await res.json();
        const tb = document.querySelector('#logs-table tbody');
        tb.innerHTML = '';
        for(const l of data){
          const tr = document.createElement('tr');
          tr.style.background = colorForScore(l.risk_score || 0);
          tr.innerHTML = `<td>${l.id}</td><td>${l.session_id}</td><td>${l.model}</td><td><pre>${escapeHtml(l.prompt||'')}</pre></td><td><pre>${escapeHtml(l.response||'')}</pre></td><td>${(l.latency_ms||0).toFixed(2)}</td><td>${l.risk_score||0}</td>`;
          tb.appendChild(tr);
        }
      }
      function escapeHtml(s){ return s.replace(/[&<>]/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;'}[c]; }); }
      document.getElementById('refresh').addEventListener('click', load);
      document.getElementById('export').addEventListener('click', async ()=>{
        const r = await fetch('/api/export_report?limit=1000');
        const j = await r.json();
        const blob = new Blob([JSON.stringify(j, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'ai_test_lab_report.json'; a.click();
      });
      load();
    </script>
  </body>
</html>
